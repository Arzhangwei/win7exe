name: Build Win7 Compatible EXE

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-win7:
    runs-on: windows-2019
    strategy:
      matrix:
        python-version: [‘3.8.10’]

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller==5.0 pandas==1.3.5 PyQt5==5.15.4 PyQt5-sip==12.9.0 phone==0.4.3

      - name: 检查必要文件
        run: |
          $requiredFiles = @(‘iphoneLocation3.0.py’， ‘phone.dat’)
          foreach ($file in $requiredFiles) {
            if (-not (Test-Path $file)) {
              Write-Error “错误：缺失必要文件 ‘$file‘，请确保它存在于仓库根目录。”
              exit 1
            }
          }

      - name: 创建版本信息文件
        run: |
          # 使用 Out-File 命令逐行创建文件，完全避免 Here-String 的缩进问题
          “VSVersionInfo(“ | Out-File -FilePath version_info.txt -Encoding utf8
          ”  ffi=FixedFileInfo(“ | Out-File -FilePath version_info.txt -Encoding utf8 -Append
          ”    filevers=(1， 0， 0， 0),“ | Out-File -FilePath version_info.txt -Encoding utf8 -Append
          ”    prodvers=(1， 0， 0， 0),“ | Out-File -FilePath version_info.txt -Encoding utf8 -Append
          ”    mask=0x3f,“ | Out-File -FilePath version_info.txt -Encoding utf8 -Append
          ”    flags=0x0,“ | Out-File -FilePath version_info.txt -Encoding utf8 -Append
          ”    OS=0x40004,“ | Out-File -FilePath version_info.txt -Encoding utf8 -Append
          ”    fileType=0x1,“ | Out-File -FilePath version_info.txt -Encoding utf8 -Append
          ”    subtype=0x0,“ | Out-File -FilePath version_info.txt -Encoding utf8 -Append
          ”    date=(0， 0)“ | Out-File -FilePath version_info.txt -Encoding utf8 -Append
          ”  ),“ | Out-File -FilePath version_info.txt -Encoding utf8 -Append
          ”  kids=[“ | Out-File -FilePath version_info.txt -Encoding utf8 -Append
          ”    StringFileInfo([“ | Out-File -FilePath version_info.txt -Encoding utf8 -Append
          ”      StringTable(“ | Out-File -FilePath version_info.txt -Encoding utf8 -Append
          ”        u'040904B0',“ | Out-File -FilePath version_info.txt -Encoding utf8 -Append
          ”        [StringStruct(u'CompanyName'， u'利辛农商行'),“ | Out-File -FilePath version_info.txt -Encoding utf8 -Append
          ”         StringStruct(u'FileDescription'， u'电话回访辅助工具'),“ | Out-File -FilePath version_info.txt -Encoding utf8 -Append
          ”         StringStruct(u'FileVersion'， u'1.0.0.0'),“ | Out-File -FilePath version_info.txt -Encoding utf8 -Append
          ”         StringStruct(u'InternalName'， u'电话回访辅助'),“ | Out-File -FilePath version_info.txt -Encoding utf8 -Append
          ”         StringStruct(u'LegalCopyright'， u'Copyright © 2023'),“ | Out-File -FilePath version_info.txt -Encoding utf8 -Append
          ”         StringStruct(u'OriginalFilename'， u'利辛农商行电话回访辅助.exe'),“ | Out-File -FilePath version_info.txt -Encoding utf8 -Append
          ”         StringStruct(u'ProductName'， u'电话回访辅助工具'),“ | Out-File -FilePath version_info.txt -Encoding utf8 -Append
          ”         StringStruct(u'ProductVersion'， u'1.0.0.0')]“ | Out-File -FilePath version_info.txt -Encoding utf8 -Append
          ”      )“ | Out-File -FilePath version_info.txt -Encoding utf8 -Append
          ”    ]),“ | Out-File -FilePath version_info.txt -Encoding utf8 -Append
          ”    VarFileInfo([VarStruct(u'Translation'， [0x409， 1200])])“ | Out-File -FilePath version_info.txt -Encoding utf8 -Append
          ”  ]“ | Out-File -FilePath version_info.txt -Encoding utf8 -Append
          ”)“ | Out-File -FilePath version_info.txt -Encoding utf8 -Append
          Write-Host “版本信息文件 version_info.txt 已创建。”

      - name: 执行打包
        # 使用单行命令，避免多行字符串和续行符的所有问题
        run: pyinstaller --name=“利辛农商行电话回访辅助” --onefile --windowed --clean --noconfirm --win-private-assemblies --exclude-module=tkinter --add-data=“phone.dat;.” --version-file=version_info.txt iphoneLocation3.0.py

      - name: 创建测试 CSV 文件
        run: |
          @‘
客户姓名，手机号码，担保人姓名，手机号码.1
张三，13805581234，李四，13905585678
王五，18712345678，赵六，18887654321
’@ | Out-File -FilePath peopleList.csv -Encoding utf8
          Write-Host “示例文件 peopleList.csv 已创建。”

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: 利辛农商行电话回访辅助_Win7版
          path: |
            dist/利辛农商行电话回访辅助.exe
            phone.dat
            peopleList.csv
          retention-days: 7
