name: Build Win7 Compatible EXE

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-win7:
    runs-on: windows-2019
    strategy:
      matrix:
        # 关键修改1：更换为环境可用的版本，并使用英文引号
        python-version: ['3.8']

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Python
        uses: actions/setup-python@v4
        with:
          # 关键修改2：引用矩阵中的变量
          python-version: ${{ matrix.python-version }}

      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller==5.0 pandas==1.3.5 PyQt5==5.15.4 phone==0.4.3

      - name: 检查必要文件
        run: |
          if (-not (Test-Path "iphoneLocation3.0.py")) { Write-Error "缺少主脚本"; exit 1 }
          if (-not (Test-Path "phone.dat")) { Write-Warning "警告：缺少 phone.dat" }

      - name: 执行打包
        run: pyinstaller --name="利辛农商行电话回访辅助" --onefile --windowed --clean --noconfirm --win-private-assemblies --add-data="phone.dat;." iphoneLocation3.0.py

      - name: 创建示例 CSV
        run: |
          "客户姓名,手机号码,担保人姓名,手机号码.1`n张三,13805581234,李四,13905585678`n王五,18712345678,赵六,18887654321" | Out-File -FilePath peopleList.csv -Encoding utf8

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: 利辛农商行电话回访辅助_Win7版
          path: |
            dist/利辛农商行电话回访辅助.exe
            phone.dat
            peopleList.csv
