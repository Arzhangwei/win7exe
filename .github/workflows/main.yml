name: Build Win7 Compatible EXE

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-win7:
    runs-on: windows-2019
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Python 3.7
        uses: actions/setup-python@v4
        with:
          python-version: '3.7'

      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install pyinstaller==4.10  # 使用更旧的 pyinstaller
          pip install pandas==1.1.5  # 旧版 pandas
          pip install PyQt5==5.15.0
          pip install phone==0.4.3

      - name: 执行打包（Win7 专用配置）
        run: |
          pyinstaller ^
            --name="利辛农商行电话回访辅助_Win7" ^
            --onefile ^
            --windowed ^
            --clean ^
            --noconfirm ^
            --disable-windows10-mode ^
            --runtime-tmpdir=. ^
            --win-private-assemblies ^
            --add-binary="C:\Windows\System32\api-ms-win-core-path-l1-1-0.dll;." ^
            --add-data="phone.dat;." ^
            --hidden-import=socket ^
            --hidden-import=_socket ^
            --hidden-import=select ^
            --hidden-import=selectors ^
            --hidden-import=queue ^
            --hidden-import=multiprocessing ^
            --hidden-import=multiprocessing.pool ^
            --hidden-import=multiprocessing.util ^
            iphoneLocation3.0.py

      - name: 创建 Readme 说明文件
        run: |
          echo "Windows 7 用户注意事项：" > Win7_Readme.txt
          echo "1. 确保系统已安装 Service Pack 1" >> Win7_Readme.txt
          echo "2. 安装 KB2533623 补丁" >> Win7_Readme.txt
          echo "3. 安装 KB2999226 补丁（Visual C++ Redistributable）" >> Win7_Readme.txt
          echo "4. 如有问题，请右键以管理员身份运行" >> Win7_Readme.txt

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: 利辛农商行电话回访辅助_Win7版
          path: |
            dist/利辛农商行电话回访辅助_Win7.exe
            phone.dat
            peopleList.csv
            Win7_Readme.txt
