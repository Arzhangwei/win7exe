name: Build Win7 Compatible EXE

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-win7:
    runs-on: windows-2019
    strategy:
      matrix:
        python-version: ['3.8.10']
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v3
    
    - name: 设置 Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller==5.0
        pip install pandas==1.3.5
        pip install PyQt5==5.15.4
        pip install PyQt5-sip==12.9.0
        pip install phone==0.4.3
    
    - name: 检查必要文件
      # 这是一个PowerShell脚本
      run: |
        if (!(Test-Path "iphoneLocation3.0.py")) { exit 1 }
        if (!(Test-Path "phone.dat")) { Write-Warning "警告: phone.dat 文件缺失" }
    
    - name: 创建版本信息文件
      run: |
        # 创建 version_info.txt 文件
        echo VSVersionInfo( > version_info.txt
        echo   ffi=FixedFileInfo( >> version_info.txt
        echo     filevers=(1, 0, 0, 0), >> version_info.txt
        echo     prodvers=(1, 0, 0, 0), >> version_info.txt
        echo     mask=0x3f, >> version_info.txt
        echo     flags=0x0, >> version_info.txt
        echo     OS=0x40004, >> version_info.txt
        echo     fileType=0x1, >> version_info.txt
        echo     subtype=0x0, >> version_info.txt
        echo     date=(0, 0) >> version_info.txt
        echo   ), >> version_info.txt
        echo   kids=[ >> version_info.txt
        echo     StringFileInfo([ >> version_info.txt
        echo       StringTable( >> version_info.txt
        echo         u'040904B0', >> version_info.txt
        echo         [StringStruct(u'CompanyName', u'利辛农商行'), >> version_info.txt
        echo          StringStruct(u'FileDescription', u'电话回访辅助工具'), >> version_info.txt
        echo          StringStruct(u'FileVersion', u'1.0.0.0'), >> version_info.txt
        echo          StringStruct(u'InternalName', u'电话回访辅助'), >> version_info.txt
        echo          StringStruct(u'LegalCopyright', u'Copyright © 2023'), >> version_info.txt
        echo          StringStruct(u'OriginalFilename', u'利辛农商行电话回访辅助.exe'), >> version_info.txt
        echo          StringStruct(u'ProductName', u'电话回访辅助工具'), >> version_info.txt
        echo          StringStruct(u'ProductVersion', u'1.0.0.0')] >> version_info.txt
        echo       ) >> version_info.txt
        echo     ]), >> version_info.txt
        echo     VarFileInfo([VarStruct(u'Translation', [0x409, 1200])]) >> version_info.txt
        echo   ] >> version_info.txt
        echo ) >> version_info.txt
    
    - name: 执行打包
      run: |
        pyinstaller ^
          --name="利辛农商行电话回访辅助" ^
          --onefile ^
          --windowed ^
          --clean ^
          --noconfirm ^
          --win-private-assemblies ^
          --exclude-module=tkinter ^
          --add-data="phone.dat;." ^
          --version-file=version_info.txt ^
          iphoneLocation3.0.py
    
    - name: 创建测试CSV文件
      run: |
        echo 客户姓名,手机号码,担保人姓名,手机号码.1 > peopleList.csv
        echo 张三,13805581234,李四,13905585678 >> peopleList.csv
        echo 王五,18712345678,赵六,18887654321 >> peopleList.csv
    
    - name: 上传构建产物
      uses: actions/upload-artifact@v4
      with:
        name: 利辛农商行电话回访辅助_Win7版
        path: |
          dist/利辛农商行电话回访辅助.exe
          phone.dat
          peopleList.csv
