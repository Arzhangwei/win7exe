name: Build Win7 Compatible EXE

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build-win7:
    runs-on: windows-2019
    strategy:
      matrix:
        # 使用 Python 3.7 以获得更好的 Windows 7 兼容性
        python-version: ['3.7']

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller==4.0
          pip install pandas==1.3.5
          pip install PyQt5==5.15.4
          pip install phone==0.4.3

      - name: 检查必要文件
        run: |
          if (-not (Test-Path "iphoneLocation3.0.py")) {
            Write-Error "缺少主脚本: iphoneLocation3.0.py"
            exit 1
          }
          if (-not (Test-Path "phone.dat")) {
            Write-Warning "警告：缺少 phone.dat 文件"
          }

      - name: 执行打包
        shell: cmd  # 使用 cmd shell 避免 PowerShell 参数解析问题
        run: |
          pyinstaller ^
            --name="利辛农商行电话回访辅助" ^
            --onefile ^
            --windowed ^
            --clean ^
            --noconfirm ^
            --disable-windows10-mode ^
            --win-private-assemblies ^
            --add-data="phone.dat;." ^
            --hidden-import=_socket ^
            iphoneLocation3.0.py

      - name: 创建示例 CSV
        run: |
          "客户姓名,手机号码,担保人姓名,手机号码.1`n张三,13805581234,李四,13905585678`n王五,18712345678,赵六,18887654321" | Out-File -FilePath peopleList.csv -Encoding utf8
          Write-Host "✅ 示例 CSV 文件已创建" -ForegroundColor Green

      - name: 验证构建结果
        run: |
          if (Test-Path "dist/利辛农商行电话回访辅助.exe") {
            $fileSize = (Get-Item "dist/利辛农商行电话回访辅助.exe").Length / 1MB
            Write-Host "✅ EXE 文件生成成功 (大小: $fileSize MB)" -ForegroundColor Green
          } else {
            Write-Error "❌ EXE 文件生成失败"
            exit 1
          }

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: 利辛农商行电话回访辅助_Win7版
          path: |
            dist/利辛农商行电话回访辅助.exe
            phone.dat
            peopleList.csv
          retention-days: 7
